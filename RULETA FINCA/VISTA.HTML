<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Finca RP — Ruleta (Responsive)</title>
  <style>
    :root{
      /* Colores base */
      --bg-1:#0b0f1e; --bg-2:#131a33; --glass:#0e143166;
      --accent:#06d6a0; --accent-2:#f72585; --text:#f8fafc; --muted:#a3adc2;
      --win:#22c55e; --danger:#ef4444; --pointer:#fbbf24;
      /* Escala y layout */
      --space-1: .5rem;   /* 8px  */
      --space-2: .75rem;  /* 12px */
      --space-3: 1rem;    /* 16px */
      --space-4: 1.25rem; /* 20px */
      --space-5: 1.5rem;  /* 24px */
      --radius: 1.25rem;  /* 20px */
      --shadow: 0 10px 30px #00000060, inset 0 0 0 1px #ffffff10;
      --maxw: 1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(900px 700px at 10% -5%, #1d2450 0%, transparent 60%),
        radial-gradient(900px 700px at 110% 10%, #3b0f2f 0%, transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display:grid; place-items:center; padding: var(--space-5);
    }

    .app{width:min(var(--maxw), 100%); display:grid; gap: var(--space-3);
      grid-template-columns: minmax(0, 380px) minmax(0, 1fr); align-items:start}
    @media (max-width: 1100px){.app{grid-template-columns:1fr}}

    .panel{background:linear-gradient(180deg, #0b1024b3, #0b1024cc);
           border:1px solid #2b3563; border-radius:var(--radius); padding:var(--space-4); backdrop-filter: blur(10px);
           box-shadow: var(--shadow)}

    .brand{display:flex; align-items:center; gap:var(--space-3); margin:0 0 var(--space-2)}
    .emblem{width:40px; height:40px; border-radius:12px; background:
      conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent)); box-shadow:0 0 0 3px #ffffff10}
    .brand h1{margin:0; font-size:clamp(18px, 2.3vw, 24px); letter-spacing:.5px}
    .badge{font-size:11px; font-weight:800; padding:4px 8px; border-radius:999px; background:linear-gradient(180deg,#111827,#0b1024); border:1px solid #2b3563; color:#cbd5e1}
    .muted{color:var(--muted); font-size:12px}

    .controls{display:grid; gap:var(--space-3)}
    .row{display:flex; gap:var(--space-2); align-items:center; flex-wrap:wrap}
    input[type="text"], textarea, input[type="color"], select{
      background:#0b1024; color:var(--text); border:1px solid #2b3563; border-radius:12px; padding:10px 12px;
      outline:none; width:100%; transition: border .2s, box-shadow .2s; min-height:44px; font-size:14px;
    }
    textarea{min-height:96px; resize:vertical}
    input[type="text"]:focus, textarea:focus, select:focus{border-color:#5b74ff; box-shadow:0 0 0 3px #5b74ff33}

    .btn{cursor:pointer; user-select:none; border:none; padding:12px 14px; border-radius:12px; font-weight:700; font-size:14px;
      background:linear-gradient(180deg, var(--accent), #10886b); color:#061015; box-shadow:0 8px 20px #06d6a055}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:linear-gradient(180deg, #0b1024, #0b1024); color:#e2e8f0; border:1px solid #2b3563; box-shadow:none}
    .btn.danger{background:linear-gradient(180deg, #ef4444, #b91c1c); color:white}
    .btn.success{background:linear-gradient(180deg, #22c55e, #15803d); color:#06210f}
    .btn.small{padding:10px 12px; font-size:12px}

    .pillbox{display:flex; gap:var(--space-2); flex-wrap:wrap; padding:var(--space-2); background:#0b1024; border:1px solid #2b3563; border-radius:12px; min-height:48px}
    .pill{display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; color:#0b1024;
      background:linear-gradient(180deg, #dbeafe, #bfdbfe); border:1px solid #93c5fd}
    .pill .x{cursor:pointer; font-weight:900; color:#1e293b}

    .stage{position:relative; display:grid; place-items:center; padding:var(--space-3)}
    .stage.has-bg{background-size:cover; background-position:center; border-radius:18px}
    canvas{width:100%; height:auto; display:block; max-width: min(720px, 100%); aspect-ratio:1/1; filter: drop-shadow(0 30px 60px #00000080)}
    .pointer{position:absolute; top:10px; width:0; height:0; border-left:clamp(12px, 2.2vw, 18px) solid transparent; border-right:clamp(12px, 2.2vw, 18px) solid transparent; border-top:clamp(18px, 3.2vw, 26px) solid var(--pointer);
      filter: drop-shadow(0 8px 20px #fbbf2466)}

    .spin-wrap{display:none !important;}
    .spin{cursor:pointer; border:4px solid var(--accent); padding:clamp(12px, 2.4vw, 16px) clamp(16px, 3vw, 22px); border-radius:999px; font-weight:900; letter-spacing:.5px; font-size:clamp(14px, 2.4vw, 18px); background:transparent; color:var(--accent); box-shadow:0 0 20px var(--accent-2); transition:0.25s;}
    .spin:hover{color:var(--accent-2); border-color:var(--accent-2); box-shadow:0 0 28px var(--accent-2);}
    .spin:disabled{opacity:.6; cursor:not-allowed}

    .toolbar{display:flex; gap:var(--space-2); flex-wrap:wrap; justify-content:center; margin-top:var(--space-2)}
    .actions{display:flex; justify-content:center; margin-top:var(--space-2);} 

    .result{margin-top:var(--space-2); text-align:center; font-weight:900; font-size:clamp(14px, 2.2vw, 18px)}
    .result.ok{color:var(--win)}

    .history{margin-top:var(--space-2)}
    details{background:#0b1024; border:1px solid #2b3563; border-radius:12px; padding:var(--space-2)}
    summary{cursor:pointer; user-select:none}
    .history ul{margin:8px 0 0; padding-left:18px}

    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:var(--space-2)}
    @media (max-width: 520px){.grid-2{grid-template-columns:1fr}}

    /* Confetti */
    .confetti{position:fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; overflow:hidden}
    .piece{position:absolute; width:8px; height:14px; opacity:0; animation: fall 1.6s ease-out forwards}
    @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg); opacity:0} 10%{opacity:1} 100%{transform:translateY(110vh) rotate(720deg); opacity:0}}

    .sep{height:1px; background:#2b3563; margin:var(--space-1) 0 var(--space-2)}

    /* Mini GTA vibe title */
    .gta{font-weight:1200; letter-spacing:.5px; text-transform:uppercase;}
    .gta span{display:inline-block; padding:2px 6px; margin:0 2px; border-radius:6px; color:#ffffff; background:transparent; box-shadow:0 2px 0 #00000080}
  </style>
</head>
<body>
  <div class="app">
    <!-- PANEL LATERAL -->
    <section class="panel">
      <div class="brand">
        <div class="emblem"></div>
        <div>
          <h1 class="gta"><span>La Finca Ruleta</span></h1>
          <div class="badge">Ruleta de premios</div>
        </div>
      </div>
      <p class="muted">Perfecta para rifas, minijuegos, sorteos de <em>La Finca RP</em>. Personaliza colores, música y fondos.</p>

      <div class="controls">
        <!-- Items -->
        <div class="row">
          <input id="itemInput" type="text" placeholder="Escribe una opción y presiona Enter o +" />
          <button class="btn" id="addBtn" title="Agregar">+</button>
        </div>
        <div class="pillbox" id="pillbox" aria-live="polite"></div>

        <div class="sep"></div>
        <label class="muted">Carga masiva (una por línea o separadas por comas):</label>
        <textarea id="bulk" placeholder="Ej: Carrera Sandy\nBoxeo en la Playa\nSorteo 25k$"></textarea>
        <div class="row">
          <button class="btn secondary small" id="bulkAdd">Añadir todas</button>
          <button class="btn danger small" id="clear">Borrar todo</button>
          <button class="btn secondary small" id="shuffle">Mezclar</button>
        </div>

        <div class="sep"></div>
        <!-- Temas -->
        <div class="grid-2">
          <label class="muted">Tema rápido
            <select id="themeSel">
              <option value="finca">La Finca RP</option>
              <option value="neon">Neón / Noche</option>
              <option value="policia">Policía</option>
              <option value="arena">Arena Sandy</option>
              <option value="ls">Los Santos Night</option>
            </select>
          </label>
          <label class="muted">Fondo (imagen URL)
            <input id="bgUrl" type="text" placeholder="Pega URL de imagen (opcional)" />
          </label>
          <label class="muted">Color principal<input id="colorA" type="color" value="#06d6a0"></label>
          <label class="muted">Color secundario<input id="colorB" type="color" value="#f72585"></label>
          <label class="muted">Borde ruleta<input id="rim" type="color" value="#e2e8f0"></label>
          <label class="muted">Centro ruleta<input id="hub" type="color" value="#ffffff"></label>
        </div>
        <div class="row">
          <label style="display:flex; align-items:center; gap:8px; font-size:14px">
            <input type="checkbox" id="randomColors" checked /> Colores aleatorios por segmento
          </label>
        </div>

        <div class="sep"></div>
        <!-- Música -->
        <div>
          <div class="row">
            <input id="musicUrl" type="text" placeholder="URL de música MP3 (opcional)" />
            <button id="musicSetUrl" class="btn secondary small">Usar URL</button>
          </div>
          <div class="row">
            <input id="musicFile" type="file" accept="audio/mpeg,audio/mp3" />
            <button id="musicPlay" class="btn small">Play</button>
            <button id="musicPause" class="btn secondary small">Pause</button>
            <label class="muted" style="display:flex; align-items:center; gap:8px">Vol <input id="vol" type="range" min="0" max="1" step="0.01" value="0.4" style="width:120px"></label>
          </div>
          <p class="muted">Tip: si subes archivo, se reproduce localmente (no guarda el archivo). La URL sí se recuerda.</p>
        </div>

        <div class="sep"></div>
        <!-- Guardado -->
        <div class="row">
          <button class="btn secondary small" id="save">Guardar (local)</button>
          <button class="btn secondary small" id="load">Cargar</button>
          <button class="btn secondary small" id="export">Exportar JSON</button>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn secondary small" id="importBtn">Importar</button>
        </div>

        <div class="history">
          <details>
            <summary>Historial de resultados</summary>
            <ul id="history"></ul>
          </details>
        </div>
      </div>
    </section>

    <!-- ESCENARIO RULETA -->
    <section class="panel stage" id="stage">
      <div class="pointer" aria-hidden="true"></div>
      <canvas id="wheel"></canvas>
      <div class="actions"><button class="spin" id="spin">GIRAR</button></div>
      <div class="toolbar">
        <button class="btn success small" id="nudgeL" title="Ajuste fino izquierda">◀︎</button>
        <button class="btn success small" id="nudgeR" title="Ajuste fino derecha">▶︎</button>
        <button class="btn secondary small" id="snap">Centrar texto</button>
      </div>
      <div id="result" class="result" role="status" aria-live="polite"></div>
    </section>
  </div>

  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
    // ====== Estado ======
    const state = {
      items: ["Carrera en Santos", "Boxeo en la Playa", "Rifa 25k$", "Captura de bandido", "Show & Shine", "Concurso drift"],
      rotation: 0,
      spinning: false,
      colors: [],
      theme: 'finca',
      musicUrl: localStorage.getItem('ruleta-music-url') || ''
    };

    // ====== Utilidades ======
    const $ = sel => document.querySelector(sel);
    const rand = (a,b) => Math.random()*(b-a)+a;
    const easeOutCubic = t => 1 - Math.pow(1-t,3);
    const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
    function setVar(n,v){ document.documentElement.style.setProperty(n, v); }

    // ====== Colores de segmentos ======
    function seedColors(){
      if(!state.items.length) return;
      const useRandom = $('#randomColors').checked;
      const a = $('#colorA').value, b = $('#colorB').value;
      state.colors = state.items.map((_,i)=> useRandom ? hue(i/state.items.length) : mix(a,b,i/(state.items.length-1||1)) );
    }
    function hue(t){ const h = Math.round(360*t); return hslToHex(h, 72, 55); }
    function hslToHex(h,s,l){ s/=100; l/=100; const k=n=> (n + h/30) % 12; const a=s*Math.min(l,1-l);
      const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
      const toHex=x=> ('0'+Math.round(255*x).toString(16)).slice(-2);
      return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`; }
    function mix(hex1, hex2, t){ const A=hexToRgb(hex1), B=hexToRgb(hex2);
      const m={r:Math.round(A.r+(B.r-A.r)*t), g:Math.round(A.g+(B.g-A.g)*t), b:Math.round(A.b+(B.b-A.b)*t)}; return rgbToHex(m.r,m.g,m.b);} 
    function hexToRgb(hex){ const v = hex.replace('#',''); return { r: parseInt(v.slice(0,2),16), g: parseInt(v.slice(2,4),16), b: parseInt(v.slice(4,6),16) }; }
    function rgbToHex(r,g,b){ const toHex=n=>('0'+n.toString(16)).slice(-2); return `#${toHex(r)}${toHex(g)}${toHex(b)}`; }

    // ====== Canvas ======
    const canvas = $('#wheel');
    const ctx = canvas.getContext('2d');

    function draw(){
      const W = canvas.width, H = canvas.height; const R = Math.min(W,H)/2 - 20 * dpr();
      ctx.clearRect(0,0,W,H);
      ctx.save(); ctx.translate(W/2, H/2); ctx.rotate(state.rotation);

      const rim = $('#rim').value; const hub = $('#hub').value;
      const n = Math.max(1, state.items.length); const a = Math.PI*2 / n;

      // borde externo
      ctx.beginPath(); ctx.arc(0,0,R+10*dpr(),0,Math.PI*2); ctx.fillStyle = rim; ctx.fill();

      // sectores
      for(let i=0;i<n;i++){
        const start = i*a, end = start + a;
        ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,start,end); ctx.closePath();
        ctx.fillStyle = state.colors[i] || hue(i/n); ctx.fill();
        ctx.strokeStyle = '#00000033'; ctx.lineWidth = 2*dpr(); ctx.stroke();

        const mid = start + a/2;
        ctx.save(); ctx.rotate(mid); ctx.translate(R*0.72,0); ctx.rotate(Math.PI/2);
        ctx.fillStyle = '#0b1024'; ctx.font = `${clamp(22 - Math.max(0, n-8)*1.2, 12, 22)*dpr()}px ui-sans-serif, system-ui`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        wrapText(ctx, (state.items[i]||'').toString(), 0, 0, R*0.45, 18*dpr());
        ctx.restore();
      }

      // centro
      ctx.beginPath(); ctx.arc(0,0,R*0.22,0,Math.PI*2);
      const g = ctx.createRadialGradient(0,0,4*dpr(),0,0,R*0.22);
      g.addColorStop(0, hub); g.addColorStop(1, '#e5e7eb');
      ctx.fillStyle = g; ctx.fill();

      ctx.restore();
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split(' '); let line = ''; let lines=[];
      for(let w of words){ const test = line ? line + ' ' + w : w; if(ctx.measureText(test).width > maxWidth && line){ lines.push(line); line = w; } else line = test; }
      lines.push(line); const total = lines.length * lineHeight; y -= total/2 + lineHeight/2;
      for(let L of lines){ y += lineHeight; ctx.fillText(L, x, y); }
    }

    function addItem(v){ v=(v||'').trim(); if(!v) return; state.items.push(v); seedColors(); updatePills(); draw(); }
    function removeIndex(i){ state.items.splice(i,1); seedColors(); updatePills(); draw(); }

    function updatePills(){ const box = $('#pillbox'); box.innerHTML='';
      state.items.forEach((txt,i)=>{ const p=document.createElement('span'); p.className='pill'; p.style.background=state.colors[i]; p.style.borderColor='#00000020'; p.style.color='#0b1024';
        p.innerHTML=`<span>${escapeHtml(txt)}</span><span class="x" title="Quitar" data-i="${i}">×</span>`; box.appendChild(p); }); }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    // Confetti
    function boom(){ const root = $('#confetti'); for(let i=0;i<120;i++){ const d=document.createElement('div'); d.className='piece';
        d.style.left=Math.random()*100+'vw'; d.style.background=i%3? '#06d6a0' : (i%5? '#f72585' : '#f59e0b'); d.style.animationDelay=(Math.random()*0.4)+'s';
        d.style.transform=`translateY(-10vh) rotate(${Math.random()*360}deg)`; root.appendChild(d); setTimeout(()=> d.remove(), 2000); } }

    // Spin
    async function spin(){ if(state.spinning || state.items.length===0) return; state.spinning=true; $('#spin').disabled=true; $('#result').textContent='';
      const n = state.items.length, seg = Math.PI*2/n; const extraSpins = Math.floor(rand(5,8)); const targetOffset = rand(0, seg);
      const start = state.rotation; const target = start + extraSpins*Math.PI*2 + targetOffset; const dur = 6000;
      const t0 = performance.now(); await new Promise(resolve=>{ const step = now =>{ const t=clamp((now-t0)/dur,0,1); const eased=easeOutCubic(t); state.rotation = start + (target - start)*eased; draw(); if(t<1) requestAnimationFrame(step); else resolve();}; requestAnimationFrame(step);});
      const a = (Math.PI*2 - (state.rotation % (Math.PI*2)) + (Math.PI*1.5)) % (Math.PI*2); const idx = Math.floor(a / seg) % n; const winner = state.items[idx];
      $('#result').textContent = `Resultado: ${winner}`; $('#result').className='result ok'; addHistory(winner); boom(); state.spinning=false; $('#spin').disabled=false; }

    function addHistory(w){ const li = document.createElement('li'); const time=new Date().toLocaleTimeString(); li.textContent = `${time} — ${w}`; $('#history').prepend(li); }

    function nudge(dir){ state.rotation += dir * 0.02; draw(); }

    // Guardar / cargar
    function save(){ localStorage.setItem('ruleta-items', JSON.stringify(state.items)); localStorage.setItem('ruleta-theme', state.theme); localStorage.setItem('ruleta-bg', $('#bgUrl').value || ''); }
    function load(){ const v=localStorage.getItem('ruleta-items'); if(v){ state.items = JSON.parse(v)||[]; } const th=localStorage.getItem('ruleta-theme'); if(th){ state.theme=th; $('#themeSel').value=th; applyTheme(th); } const bg=localStorage.getItem('ruleta-bg'); if(bg){ $('#bgUrl').value=bg; applyBg(bg); } seedColors(); updatePills(); draw();
      const url = localStorage.getItem('ruleta-music-url'); if(url){ state.musicUrl=url; $('#musicUrl').value=url; }
    }

    function exportJSON(){ const blob=new Blob([JSON.stringify({items:state.items, theme:state.theme, bg:$('#bgUrl').value||''}, null, 2)], {type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ruleta-finca.json'; a.click(); URL.revokeObjectURL(url); }
    function importJSON(file){ const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(Array.isArray(data.items)){ state.items=data.items; } if(data.theme){ state.theme=data.theme; $('#themeSel').value=data.theme; applyTheme(data.theme);} if(data.bg){ $('#bgUrl').value=data.bg; applyBg(data.bg);} seedColors(); updatePills(); draw(); }catch(e){ alert('Archivo no válido'); } }; r.readAsText(file); }

    // ====== Temas ======
    const stage = $('#stage');
    function applyBg(url){ if(url && url.trim()){ stage.classList.add('has-bg'); stage.style.backgroundImage = `linear-gradient(#00000066,#00000066), url('${url}')`; } else { stage.classList.remove('has-bg'); stage.style.backgroundImage = 'none'; } }
    function applyTheme(name){
      state.theme = name;
      if(name==='finca'){
        setVar('--bg-1','#0b0f1e'); setVar('--bg-2','#131a33'); setVar('--accent','#06d6a0'); setVar('--accent-2','#f72585'); setVar('--pointer','#fbbf24');
      }else if(name==='neon'){
        setVar('--bg-1','#06080f'); setVar('--bg-2','#0a0f20'); setVar('--accent','#00e5ff'); setVar('--accent-2','#bd00ff'); setVar('--pointer','#00e5ff');
      }else if(name==='policia'){
        setVar('--bg-1','#0b1020'); setVar('--bg-2','#0e1a3a'); setVar('--accent','#3b82f6'); setVar('--accent-2','#ef4444'); setVar('--pointer','#ffd700');
      }else if(name==='arena'){
        setVar('--bg-1','#1a1814'); setVar('--bg-2','#3a2f1a'); setVar('--accent','#f59e0b'); setVar('--accent-2','#10b981'); setVar('--pointer','#fde68a');
      }else if(name==='ls'){
        setVar('--bg-1','#0f1126'); setVar('--bg-2','#241238'); setVar('--accent','#a78bfa'); setVar('--accent-2','#22d3ee'); setVar('--pointer','#e879f9');
      }
      seedColors(); updatePills(); draw();
    }

    // ====== Música ======
    const audio = new Audio(); audio.loop = true; audio.volume = parseFloat($('#vol').value);
    function useMusicUrl(url){ if(!url) return; state.musicUrl=url; localStorage.setItem('ruleta-music-url', url); try{ audio.src = url; }catch(e){ alert('URL inválida'); } }
    function useMusicFile(file){ if(!file) return; const url = URL.createObjectURL(file); audio.src = url; audio.play(); setTimeout(()=> URL.revokeObjectURL(url), 60*1000*5); }

    // ====== Canvas responsive (HiDPI) ======
    function dpr(){ return Math.max(1, Math.min(window.devicePixelRatio || 1, 2)); }
    function resizeCanvas(){
      const pad = 32; // padding interno del panel
      const maxSide = 720; // tamaño máximo visual
      const avail = Math.min(stage.clientWidth - pad*2, window.innerHeight - 260, maxSide);
      const size = Math.max(260, avail);
      const ratio = dpr();
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      canvas.width = Math.round(size * ratio);
      canvas.height = Math.round(size * ratio);
      draw();
    }
    let resizeTimer=null;
    window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(resizeCanvas, 100); });

    // ====== Wiring ======
    $('#addBtn').addEventListener('click', ()=>{ addItem($('#itemInput').value); $('#itemInput').value=''; $('#itemInput').focus(); });
    $('#itemInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ addItem(e.target.value); e.target.value=''; }});
    $('#bulkAdd').addEventListener('click', ()=>{ const raw=$('#bulk').value.trim(); if(!raw) return; raw.split(/\n|,/).map(s=>s.trim()).filter(Boolean).forEach(addItem); $('#bulk').value=''; });
    $('#clear').addEventListener('click', ()=>{ if(confirm('¿Eliminar todas las opciones?')){ state.items=[]; seedColors(); updatePills(); draw(); }});
    $('#shuffle').addEventListener('click', ()=>{ state.items = state.items.sort(()=>Math.random()-.5); seedColors(); updatePills(); draw(); });

    $('#randomColors').addEventListener('change', ()=>{ seedColors(); updatePills(); draw(); });
    ['colorA','colorB','rim','hub'].forEach(id=> document.getElementById(id).addEventListener('input', ()=>{ seedColors(); updatePills(); draw(); }));

    $('#spin').addEventListener('click', spin);
    $('#nudgeL').addEventListener('click', ()=>nudge(-1));
    $('#nudgeR').addEventListener('click', ()=>nudge(1));
    $('#snap').addEventListener('click', ()=>{ state.rotation = Math.round(state.rotation/(Math.PI*2))*(Math.PI*2); draw(); });

    $('#save').addEventListener('click', ()=>{ save(); alert('Guardado en este navegador ✔'); });
    $('#load').addEventListener('click', ()=>{ load(); alert('Cargado ✔'); });
    $('#export').addEventListener('click', exportJSON);
    $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
    $('#importFile').addEventListener('change', e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); e.target.value=''; });

    $('#pillbox').addEventListener('click', e=>{ if(e.target.classList.contains('x')){ const i = +e.target.dataset.i; removeIndex(i); }});

    // Temas & Fondo
    $('#themeSel').addEventListener('change', e=> applyTheme(e.target.value));
    $('#bgUrl').addEventListener('change', e=>{ applyBg(e.target.value); });

    // Música
    $('#musicSetUrl').addEventListener('click', ()=> useMusicUrl($('#musicUrl').value.trim()));
    $('#musicFile').addEventListener('change', e=> useMusicFile(e.target.files[0]));
    $('#musicPlay').addEventListener('click', ()=>{ if(audio.src){ audio.play(); } else if(state.musicUrl){ useMusicUrl(state.musicUrl); audio.play(); } else { alert('Agrega una URL o un archivo MP3.'); }});
    $('#musicPause').addEventListener('click', ()=> audio.pause());
    $('#vol').addEventListener('input', e=> audio.volume = parseFloat(e.target.value));

    // Inicializar
    applyTheme(state.theme); seedColors(); updatePills(); applyBg(localStorage.getItem('ruleta-bg')||'');
    resizeCanvas(); draw(); load(); if(state.musicUrl){ useMusicUrl(state.musicUrl); }
  </script>
</body>
</html>
